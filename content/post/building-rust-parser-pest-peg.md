---
title: "ä½¿ç”¨ Pest å’Œ PEG æ„å»º Rust è§£æå™¨ã€è¯‘ã€‘"
date: 2024-04-19
tags: ["rust", "dsl", "rust-lib"]
draft: false
---

> æœ¬æ–‡åŸä¸ºä¸º https://blog.logrocket.com/building-rust-parser-pest-peg/ï¼Œä½¿ç”¨Googleç¿»è¯‘è¿›è¡Œæœºç¿»ï¼Œéƒ¨åˆ†å†…å®¹åšäº†ç»†å¾®æ¶¦è‰²ã€‚

ç¼–å†™ä¸€ä¸ªé«˜æ•ˆçš„è¯æ³•åˆ†æå™¨å¯¹æ¥è§£æå¤æ‚çš„ç»“æ„å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ã€‚å¦‚æœæ ¼å¼æˆ–ç»“æ„æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”æ‚¨å¿…é¡»ä»¥æ˜“äºç†è§£ã€ç»´æŠ¤å’Œæ‰©å±•ä»¥é€‚åº”æœªæ¥æ›´æ”¹çš„æ–¹å¼ç¼–å†™è§£æå™¨ï¼Œé‚£ä¹ˆè¿™ä¼šå˜å¾—æ›´åŠ å¤æ‚ã€‚

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è§£æå™¨ç”Ÿæˆå™¨ï¼Œè€Œä¸æ˜¯æ‰‹å†™è§£æå™¨æˆ–æ‰‹åŠ¨è§£ææˆ‘ä»¬çš„é¡¹ç›®ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å›é¡¾ä»€ä¹ˆæ˜¯è§£æå™¨ç”Ÿæˆå™¨ï¼Œå¹¶æ¢ç´¢ä¸€ä¸ªåä¸º Pest çš„ Rust è§£æå·¥å…·ã€‚æˆ‘ä»¬å°†æ¶µç›–ï¼š

[TOC]

è¯·æ³¨æ„ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿè½»æ¾åœ°é˜…è¯»å’Œç¼–å†™åŸºæœ¬çš„ Rust ä»£ç ï¼Œä¾‹å¦‚å‡½æ•°ã€ç»“æ„å’Œå¾ªç¯ã€‚

## ä»€ä¹ˆæ˜¯è§£æå™¨ç”Ÿæˆå™¨ï¼Ÿ

è§£æå™¨ç”Ÿæˆå™¨æ˜¯ä¸€äº›ç¨‹åºï¼Œå®ƒæ¥å—è§£æå™¨éœ€è¦è€ƒè™‘çš„è§„åˆ™ï¼Œç„¶åä»¥ç¼–ç¨‹æ–¹å¼ä¸ºæ‚¨ç”Ÿæˆä¸€ä¸ªè§£æå™¨ï¼Œè¯¥è§£æå™¨å°†æ ¹æ®è¿™äº›è§„åˆ™è§£æè¾“å…¥ã€‚

å¤§å¤šæ•°æ—¶å€™ï¼Œè§„åˆ™ä»¥ç®€åŒ–è¯­è¨€ï¼ˆä¾‹å¦‚æ­£åˆ™è¡¨è¾¾å¼ï¼‰æä¾›ç»™è§£æå™¨ç”Ÿæˆå™¨ã€‚å› æ­¤ï¼Œå½“æ‚¨æƒ³è¦é€šè¿‡æ›´æ”¹è§„åˆ™æˆ–æ·»åŠ æ–°è§„åˆ™æ¥æ›´æ–°è§£æå™¨æ—¶ï¼Œæ‚¨åªéœ€æ›´æ–°æˆ–æ·»åŠ è§„åˆ™çš„æ­£åˆ™è¡¨è¾¾å¼å³å¯ã€‚ç„¶åï¼Œå½“æ‚¨è¿è¡Œè§£æå™¨ç”Ÿæˆå™¨æ—¶ï¼Œå®ƒå°†é‡å†™è§£æå™¨ä»¥é€‚åº”è¿™äº›è§„åˆ™ã€‚

å¯ä»¥æƒ³è±¡ä½¿ç”¨è¿™æ ·çš„è§£æå·¥å…·å¯ä»¥èŠ‚çœå¤šå°‘æ—¶é—´ã€‚è®¸å¤šè§£æå™¨ç”Ÿæˆå™¨è¿˜ä¼šç”Ÿæˆè¯æ³•åˆ†æå™¨ï¼Œå› æ­¤æ‚¨ä¸å¿…è‡ªå·±ç¼–å†™è¯æ³•åˆ†æå™¨ã€‚å¦‚æœç”Ÿæˆçš„è¯æ³•åˆ†æå™¨ä¸é€‚åˆæ‚¨ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨æ‚¨è‡ªå·±çš„è¯æ³•åˆ†æå™¨è¿è¡Œè§£æå™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚

ç›®å‰ï¼ŒRust ç”Ÿæ€ç³»ç»Ÿä¸­æœ‰å¤šä¸ªè§£æå™¨ç”Ÿæˆå™¨å¯ä¾›æ‚¨ä½¿ç”¨ã€‚å…¶ä¸­æœ€å—æ¬¢è¿çš„ä¸‰ä¸ªæ˜¯ LalrPopã€Nom å’Œ Pestã€‚

LalrPop ä¸ Yacc éå¸¸ç›¸ä¼¼ï¼Œå®ƒè®©æ‚¨å®šä¹‰è§„åˆ™å’Œç›¸åº”çš„æ“ä½œã€‚æˆ‘ä¸ªäººç”¨å®ƒæ¥ä¸ºæˆ‘çš„ 8086 æ¨¡æ‹Ÿå™¨é¡¹ç›®ç¼–å†™è§„åˆ™ã€‚

Nom æ˜¯ä¸€ä¸ªè§£æå™¨ç»„åˆå™¨åº“ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­å°†è§„åˆ™ç¼–å†™ä¸ºå‡½æ•°ç»„åˆã€‚è¿™æ›´é¢å‘è§£æäºŒè¿›åˆ¶è¾“å…¥ï¼Œä½†ä¹Ÿå¯ç”¨äºè§£æå­—ç¬¦ä¸²ã€‚

æœ€åï¼ŒPest ä½¿ç”¨ Parsing Expression Grammar æ¥å®šä¹‰è§£æè§„åˆ™ã€‚æˆ‘ä»¬å°†åœ¨è¿™ç¯‡æ–‡ç« ä¸­è¯¦ç»†æ¢è®¨ Rust ä¸ Pest çš„è§£æã€‚

## Pest ä¸­çš„è§£æè¡¨è¾¾å¼è¯­æ³•æ˜¯ä»€ä¹ˆï¼Ÿ

è§£æè¡¨è¾¾å¼è¯­æ³•ï¼ˆPEGï¼‰æ˜¯ç”¨ Pest å®šä¹‰ Rust è§£æâ€œè§„åˆ™â€çš„æ–¹æ³•ä¹‹ä¸€ã€‚ Pest æ¥å—å…·æœ‰æ­¤ç±»è§„åˆ™å®šä¹‰çš„æ–‡ä»¶çš„è¾“å…¥ï¼Œå¹¶ç”Ÿæˆéµå¾ªå®ƒä»¬çš„ Rust è§£æå™¨ã€‚

åœ¨ç¼–å†™è§„åˆ™æ—¶ï¼Œæ‚¨åº”è¯¥è€ƒè™‘ Pest å’Œ PEG çš„ä¸‰ä¸ªå®šä¹‰ç‰¹å¾ã€‚

ç¬¬ä¸€ä¸ªç‰¹ç‚¹æ˜¯è´ªå©ªåŒ¹é…ã€‚ Pest å°†å§‹ç»ˆå°è¯•å°†è¾“å…¥çš„æœ€å¤§å€¼ä¸è§„åˆ™ç›¸åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬ç¼–å†™äº†å¦‚ä¸‹è§„åˆ™ï¼š

```
match one or more alphabets
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒPest å°†æ¶ˆè€—è¾“å…¥ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œç›´åˆ°è¾¾åˆ°æ•°å­—ã€ç©ºæ ¼æˆ–ç¬¦å·ã€‚åœ¨æ­¤ä¹‹å‰å®ƒä¸ä¼šåœæ­¢ã€‚

è¦è€ƒè™‘çš„ç¬¬äºŒä¸ªç‰¹å¾æ˜¯äº¤æ›¿åŒ¹é…æ˜¯æœ‰åºçš„ã€‚ä¸ºäº†ç†è§£è¿™æ„å‘³ç€ä»€ä¹ˆï¼Œå‡è®¾æˆ‘ä»¬ç»™å‡ºäº†å¤šä¸ªåŒ¹é…æ¥æ»¡è¶³ä¸€æ¡è§„åˆ™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
rule1 | rule2 | rule3
```

Pest å°†é¦–å…ˆå°è¯•åŒ¹é… `rule1` ã€‚å½“ä¸”ä»…å½“ `rule1` å¤±è´¥æ—¶ï¼ŒPestæ‰ä¼šå°è¯•åŒ¹é… `rule2` ï¼Œä¾æ­¤ç±»æ¨ã€‚å¦‚æœç¬¬ä¸€æ¡è§„åˆ™åŒ¹é…ï¼ŒPest å°†ä¸ä¼šå°è¯•åŒ¹é…ä»»ä½•å…¶ä»–è§„åˆ™æ¥æ‰¾åˆ°æœ€ä½³åŒ¹é…ã€‚

å› æ­¤ï¼Œåœ¨ç¼–å†™æ­¤ç±»æ›¿ä»£æ–¹æ¡ˆæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»å°†æœ€å…·ä½“çš„æ›¿ä»£æ–¹æ¡ˆæ”¾åœ¨å‰é¢ï¼Œå°†æœ€ä¸€èˆ¬çš„æ›¿ä»£æ–¹æ¡ˆæ”¾åœ¨æœ€åã€‚ä¸‹ä¸€èŠ‚å°†å¯¹æ­¤è¿›è¡Œæ›´è¯¦ç»†çš„è§£é‡Šã€‚

ç¬¬ä¸‰ä¸ªç‰¹æ€§â€”â€”æ— å›æº¯â€”â€”æ„å‘³ç€å¦‚æœè§„åˆ™æ— æ³•åŒ¹é…ï¼Œè§£æå™¨å°†ä¸ä¼šå›æº¯ã€‚ç›¸åï¼ŒPest ä¼šå°è¯•å¯»æ‰¾æ›´å¥½çš„è§„åˆ™æˆ–é€‰æ‹©æœ€ä½³çš„æ›¿ä»£åŒ¹é…ã€‚

è¿™ä¸ä½¿ç”¨æ™®é€šæ­£åˆ™è¡¨è¾¾å¼æˆ–å…¶ä»–ç±»å‹çš„è§£æå™¨ä¸åŒï¼Œå³ä½¿æ²¡æœ‰ç»™å‡ºæ›¿ä»£é€‰æ‹©ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥è¿”å›ä¸€äº›æ ‡è®°å¹¶å°è¯•æ‰¾åˆ°æ›¿ä»£è§„åˆ™ã€‚

æ‚¨å¯ä»¥åœ¨ Pest æ–‡æ¡£ä¸­æ›´è¯¦ç»†åœ°äº†è§£è¿™äº›å’Œå…¶ä»–ç‰¹å¾ã€‚

## åœ¨ Pest ä¸­ä½¿ç”¨ PEG å£°æ˜ Rust è§£æå™¨çš„è§„åˆ™

åœ¨ Pest ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç±»ä¼¼äºæ­£åˆ™è¡¨è¾¾å¼çš„è¯­æ³•æ¥å®šä¹‰è§„åˆ™ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å·®å¼‚ã€‚è®©æˆ‘ä»¬é€šè¿‡å†™ä¸€äº›ä¾‹å­æ¥çœ‹çœ‹å®é™…çš„è¯­æ³•ã€‚

ä»»ä½•è§„åˆ™çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```
RULE_NAME = { rule definition }
```

å¤§æ‹¬å·å‰é¢å¯ä»¥æœ‰ `_` å’Œ `@` ç­‰ç¬¦å·ã€‚ç¨åæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™äº›ç¬¦å·çš„å«ä¹‰ã€‚

### ä½¿ç”¨ Pest ä¸­çš„å†…ç½®è§„åˆ™åŒ¹é…å•ä¸ªå­—ç¬¦

Pest æœ‰ä¸€äº›å†…ç½®è§„åˆ™æ¥åŒ¹é…æŸäº›å­—ç¬¦æˆ–å­—ç¬¦é›†ã€‚

å¼•å·ä¸­çš„ä»»ä½•å­—ç¬¦æˆ–å­—ç¬¦ä¸²éƒ½ä¸å…¶è‡ªèº«åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œ `"a"` å°†åŒ¹é… `a` å­—ç¬¦ï¼Œ `"true"` å°†åŒ¹é…å­—ç¬¦ä¸² `true` ï¼Œä¾æ­¤ç±»æ¨ã€‚

`ANY` æ˜¯åŒ¹é…ä»»ä½• Unicode å­—ç¬¦çš„è§„åˆ™ï¼ŒåŒ…æ‹¬ç©ºæ ¼ã€æ¢è¡Œç¬¦ä»¥åŠé€—å·å’Œåˆ†å·ç­‰ç¬¦å·ã€‚

`ASCII_DIGIT` å°†åŒ¹é…æ•°å­—æˆ–æ•°å­—å­—ç¬¦ - æ¢å¥è¯è¯´ï¼Œä»¥ä¸‹å­—ç¬¦ä¸­çš„ä»»ä½•å­—ç¬¦ï¼š

```
0123456789
```

`ASCII_ALPHA` å°†åŒ¹é…å°å†™å’Œå¤§å†™å­—æ¯å­—ç¬¦ - æ¢å¥è¯è¯´ï¼Œä»¥ä¸‹å­—ç¬¦ä¸­çš„ä»»ä½•å­—ç¬¦ï¼š

```
abcdefghijklmnopqrstuvwxyz
ABCDEFGHIJKLMNOPQRSTUVWXYZ
```

æ‚¨å¯ä»¥ä½¿ç”¨ `ASCII_ALPHA_LOWER` å’Œ `ASCII_ALPHA_UPPER` æ¥ä¸“é—¨åŒ¹é…å„è‡ªå¤§å°å†™çš„å¤§å†™å’Œå°å†™å­—ç¬¦ã€‚

æœ€åï¼Œ `NEWLINE` å°†åŒ¹é…è¡¨ç¤ºæ¢è¡Œç¬¦çš„æ§åˆ¶å­—ç¬¦ï¼Œä¾‹å¦‚ `\n` ã€ `\n\r` æˆ– `\r` ã€‚

Pest æ–‡æ¡£ä¸­è¿˜è§£é‡Šäº†å…¶ä»–å‡ ä¸ªå†…ç½®è§„åˆ™ï¼Œä½†å¯¹äºæˆ‘ä»¬å°†è¦æ„å»ºçš„å°ç¨‹åºï¼Œä¸Šè¿°è§„åˆ™åº”è¯¥è¶³å¤Ÿäº†ã€‚

è¯·æ³¨æ„ï¼Œä¸Šè¿°æ‰€æœ‰è§„åˆ™ä»…åŒ¹é…å…¶ç±»å‹çš„å•ä¸ªå­—ç¬¦ï¼Œè€Œä¸åŒ¹é…å¤šä¸ªå­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œå¯¹äºè¾“å…¥ `abcde` ï¼Œè¯·è€ƒè™‘å¦‚ä¸‹è§„åˆ™ï¼š

```
my_rule = { ASCII_ALPHA }
```

æ­¤è§„åˆ™å°†ä»…åŒ¹é… `a` å­—ç¬¦ï¼Œè€Œè¾“å…¥çš„å…¶ä½™éƒ¨åˆ† - `bcde` - å°†è¢«ä¼ é€’ä»¥è¿›è¡Œè¿›ä¸€æ­¥è§£æã€‚

### ä½¿ç”¨é‡å¤åŒ¹é…å¤šä¸ªå­—ç¬¦

ç°åœ¨æˆ‘ä»¬çŸ¥é“å¦‚ä½•åŒ¹é…å•ä¸ªå­—ç¬¦ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åŒ¹é…å¤šä¸ªå­—ç¬¦ã€‚é‡å¤æœ‰ä¸‰ç§é‡è¦ç±»å‹ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢ä»‹ç»ã€‚

åŠ å· `+` è¡¨ç¤ºâ€œä¸€ä¸ªæˆ–å¤šä¸ªâ€ã€‚åœ¨è¿™é‡Œï¼ŒRust è§£æå™¨å°†å°è¯•åŒ¹é…è‡³å°‘ä¸€æ¬¡å‡ºç°çš„è§„åˆ™ã€‚å¦‚æœå‡ºç°å¤šæ¬¡ï¼ŒPest å°†åŒ¹é…æ‰€æœ‰è¿™äº›ã€‚å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•åŒ¹é…é¡¹ï¼Œåˆ™ä¼šè¢«è§†ä¸ºé”™è¯¯ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰ä¸€ä¸ªæ•°å­—ï¼š

```
NUMBER = { ASCII_DIGIT+ }
```

å¦‚æœå­˜åœ¨éæ•°å­—å­—ç¬¦ï¼ˆä¾‹å¦‚å­—æ¯å­—ç¬¦æˆ–ç¬¦å·ï¼‰ï¼Œæ­¤è§„åˆ™å°†ç»™å‡ºé”™è¯¯ã€‚

æ˜Ÿå· `*` è¡¨ç¤ºâ€œé›¶ä¸ªæˆ–å¤šä¸ªâ€ã€‚å½“æˆ‘ä»¬æƒ³è¦å…è®¸å¤šæ¬¡å‡ºç°ï¼Œä½†å³ä½¿æ²¡æœ‰é”™è¯¯ä¹Ÿä¸ç»™å‡ºä»»ä½•é”™è¯¯æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œå®šä¹‰åˆ—è¡¨æ—¶ï¼Œç¬¬ä¸€ä¸ªå€¼åé¢å¯ä»¥æœ‰é›¶ä¸ªæˆ–å¤šä¸ªé€—å·å€¼å¯¹ã€‚æ‚¨ç°åœ¨å¯ä»¥å¿½ç•¥ä¸‹é¢ä»£ç ä¸­çš„ tilda `~` ï¼Œå› ä¸ºæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­çœ‹åˆ°å®ƒçš„å«ä¹‰ï¼š

```
LIST = { "[" ~ NUMBER ~ ("," ~ NUMBER)* "]" }
```

ä¸Šé¢çš„è§„åˆ™è§„å®šåˆ—è¡¨ä»¥ `[` å¼€å¤´ï¼Œç„¶åæ˜¯ `NUMBER` ï¼Œä¹‹åå¯ä»¥æœ‰é›¶å¯¹æˆ–å¤šå¯¹ `, number` ç»„ã€‚å®ƒä»¬è¢«åˆ†ç»„åœ¨æ‹¬å·ä¸­ï¼Œå¹¶åœ¨æ•´ä¸ªæ‹¬å·ç»„ä¸ŠåŠ ä¸Šæ˜Ÿå· `*` ã€‚æœ€åï¼Œåˆ—è¡¨ä»¥å³æ‹¬å· `]` ç»“å°¾ã€‚

æ­¤è§„åˆ™å°†åŒ¹é… `[0]` ã€ `[1,2]` ã€ `[1,2,3]` ç­‰ã€‚ä½†æ˜¯ï¼Œå®ƒä¼šåœ¨ `1` ä¸Šå¤±è´¥ï¼Œå› ä¸ºæ²¡æœ‰å·¦æ‹¬å· `[` ï¼Œä»¥åŠ `[1` ï¼Œå› ä¸ºæ²¡æœ‰å³æ‹¬å· `]` > å‘ˆç°ã€‚

æœ€åï¼Œé—®å· `?` åŒ¹é…é›¶ä¸ªæˆ–ä¸€ä¸ªï¼Œä½†ä¸èƒ½è¶…è¿‡ä¸€ä¸ªã€‚ä¾‹å¦‚ï¼Œè¦å…è®¸åœ¨ä¸Šé¢çš„åˆ—è¡¨ä¸­ä½¿ç”¨å°¾éšé€—å·ï¼Œæˆ‘ä»¬å¯ä»¥å¦‚ä¸‹å£°æ˜ï¼š

```
LIST = { "[" ~ NUMBER ~ ("," ~ NUMBER)* ","? "]" }
```

æ­¤æ›´æ”¹å°†å…è®¸ `[1]` å’Œ `[1,]` ã€‚

é™¤äº†è¿™ä¸‰ä¸ªé€‰é¡¹ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–æŒ‡å®šé‡å¤çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬å…è®¸é‡å¤å›ºå®šæ¬¡æ•°çš„æ–¹æ³•ï¼Œæˆ–æœ€å¤š `n` æ¬¡ï¼Œæˆ–åœ¨ `n` å’Œ `m`

### ä¸åºåˆ—çš„éšå¼åŒ¹é…

æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­çœ‹åˆ°çš„ tilda `~` ç”¨äºè¡¨ç¤ºåºåˆ—ã€‚ä¾‹å¦‚ï¼Œ `A ~ B ~ C` ç¿»è¯‘ä¸ºâ€œåŒ¹é…è§„åˆ™ Aï¼Œç„¶ååŒ¹é… Bï¼Œç„¶ååŒ¹é… Cã€‚â€

ä½¿ç”¨æ˜¾å¼ `~` æ¥è¡¨ç¤ºæ­¤åºåˆ—æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸º `~` ç¬¦å·å‘¨å›´å­˜åœ¨ä¸€äº›éšå¼çš„ç©ºç™½åŒ¹é…ã€‚è¿™æ˜¯å› ä¸ºåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œç¼–ç è§„åˆ™å’Œè¯­æ³•ä¼šå¿½ç•¥ç©ºæ ¼ã€‚ä¾‹å¦‚ï¼Œ `if ( true)` ä¸ `if( true )` å’Œ `if (true )` ç›¸åŒã€‚

å› æ­¤ï¼ŒPest ç”Ÿæˆçš„è§£æå™¨å°†è‡ªåŠ¨ä¸ºæˆ‘ä»¬æ‰§è¡Œæ­¤æ“ä½œï¼Œè€Œä¸æ˜¯å¼€å‘äººå‘˜åœ¨æ¯ä¸ªåœ°æ–¹æ‰‹åŠ¨æ£€æŸ¥è¿™ä¸€ç‚¹ã€‚è¿™ç§éšå¼åŒ¹é…çš„å…·ä½“ç»†èŠ‚å°†åœ¨ä¸‹é¢çš„åç»­éƒ¨åˆ†ä¸­è§£é‡Šã€‚

### è¡¨è¾¾æ›¿ä»£é€‰æ‹©

æœ‰æ—¶æ‚¨å¯èƒ½æƒ³è¦è¡¨è¾¾å…è®¸ä¸å®šä¹‰çš„è§„åˆ™åŒ¹é…çš„å¤šä¸ªè§„åˆ™ã€‚ä¾‹å¦‚ï¼Œåœ¨ JSON ä¸­ï¼Œå€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•°ç»„æˆ–å¯¹è±¡ï¼Œç­‰ç­‰ã€‚

å¯¹äºè¿™ç§â€œORâ€åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç«–çº¿ `|` ç¬¦å·æ¥è¡¨è¾¾æ›¿ä»£é€‰æ‹©çš„æƒ³æ³•ã€‚ä¸Šé¢çš„ JSON æ¦‚å¿µå¯ä»¥å†™æˆè¿™æ ·çš„è§„åˆ™ï¼š

```
VALUE = { STRING | ARRAY | OBJECT }
```

è¯·æ³¨æ„ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œåœ¨è§£é‡Š PEG ç‰¹å¾æ—¶ï¼Œè¿™äº›é€‰æ‹©æ˜¯åœ¨é¦–æ¬¡åŒ¹é…çš„åŸºç¡€ä¸Šåšå‡ºçš„ã€‚å› æ­¤ï¼Œè€ƒè™‘å¦‚ä¸‹è§„åˆ™ï¼š

```
RULE = { "cat" | "cataract" | "catastrophe" }
```

æ­¤è§„åˆ™æ°¸è¿œä¸ä¼šåŒ¹é… `cataract` å’Œ `catastrophe` ï¼Œå› ä¸ºè§£æå™¨ä¼šå°†ä¸¤è€…çš„èµ·å§‹ `cat-` éƒ¨åˆ†ä¸ç¬¬ä¸€æ¡è§„åˆ™ `cat` ç›¸åŒ¹é…ï¼Œå¹¶ä¸”é‚£ä¹ˆå®ƒå°±ä¸ä¼šå°è¯•åŒ¹é…ä»»ä½•å…¶ä»–å­—æ¯ã€‚åŒ¹é… `cat` åï¼Œè§£æå™¨ä¼šå°†å‰©ä½™çš„è¾“å…¥ - `-aract` å’Œ `-astrophe` - ä¼ é€’åˆ°ä¸‹ä¸€æ­¥ï¼Œå®ƒå¯èƒ½ä¸ä¼šåŒ¹é…ä»»ä½•å†…å®¹å¹¶å¯¼è‡´è§£æå¤±è´¥ã€‚

ä¸ºäº†ç¡®ä¿ç«–çº¿ `|` è¾¾åˆ°é¢„æœŸæ•ˆæœï¼Œè¯·è®°ä½å§‹ç»ˆåœ¨å¼€å¤´æŒ‡å®šæœ€å…·ä½“çš„è§„åˆ™ï¼Œåœ¨ç»“å°¾æŒ‡å®šæœ€é€šç”¨çš„è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œä¸Šé¢çš„æ­£ç¡®è¡¨è¾¾æ–¹å¼å¦‚ä¸‹ï¼š

```
RULE = { "catastrophe" | "cataract" | "cat" }
```

è¿™é‡Œï¼Œ `cataract` å’Œ `catastrophe` çš„é¡ºåºå¹¶ä¸é‡è¦ï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯å½¼æ­¤çš„å­å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”è¾“å…¥åŒ¹é…ä¸€ä¸ªå°†ä¸ä¼šåŒ¹é…å¦ä¸€ä¸ªã€‚è®©æˆ‘ä»¬å¿«é€Ÿçœ‹ä¸€ä¸‹å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µçš„ç¤ºä¾‹æ¡ˆä¾‹ï¼š

```
all_queues = { "queue" | "que" | "q" }
```

åŒ¹é… `queue` åŠå…¶å˜ä½“ `que` å’Œ `q` æ—¶ä½¿ç”¨çš„é¡ºåºåœ¨è¿™é‡Œå¾ˆé‡è¦ï¼Œå› ä¸ºåé¢çš„å­—ç¬¦ä¸²æ˜¯ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²çš„å­å­—ç¬¦ä¸²ã€‚è§£æå™¨å°†é¦–å…ˆå°è¯•å°†è¾“å…¥ä¸ `queue` åŒ¹é…ï¼›ä»…å½“å¤±è´¥æ—¶ï¼Œè§£æå™¨æ‰ä¼šå°è¯•å°†å…¶ä¸ `que` åŒ¹é…ã€‚å¦‚æœä¹Ÿå¤±è´¥ï¼Œè§£æå™¨æœ€ç»ˆå°†å°è¯•åŒ¹é… `q` ã€‚

### äº†è§£é™éŸ³ã€åŸå­å’Œé—´è·

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ä¸‹åˆ’çº¿ `_` å’Œ at `@` ç¬¦å·çš„å«ä¹‰ã€‚

åœ¨ Pest ç”Ÿæˆçš„è§£æå™¨ä¸­ï¼Œæ¯ä¸ªåŒ¹é…çš„è§„åˆ™éƒ½ä¼šç”Ÿæˆä¸€ä¸ª `Pair` ï¼Œå…¶ä¸­åŒ…å«åŒ¹é…çš„è¾“å…¥åŠå…¶åŒ¹é…çš„è§„åˆ™ã€‚ç„¶è€Œï¼Œæœ‰æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³è¦åŒ¹é…ä¸€äº›è§„åˆ™ä»¥ç¡®ä¿éµå¾ªè¯­æ³•ï¼Œä½†åˆæƒ³å¿½ç•¥è¿™äº›è§„åˆ™çš„å†…å®¹ï¼Œå› ä¸ºå®ƒä»¬å¹¶ä¸é‡è¦ã€‚

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è¯¥è§„åˆ™çš„å·¦å¤§æ‹¬å· `{` ä¹‹å‰æ”¾ç½®ä¸€ä¸ªä¸‹åˆ’çº¿ `_` æ¥å°†è¯¥è§„åˆ™è¡¨ç¤ºä¸ºé™é»˜ï¼Œè€Œä¸æ˜¯å®ƒç”Ÿæˆæˆ‘ä»¬ç„¶ååœ¨ä»£ç ä¸­å¿½ç•¥çš„æ ‡è®°ã€‚å®šä¹‰ã€‚

è¯¥ç­–ç•¥æœ€å¸¸è§çš„ç”¨ä¾‹æ˜¯å¿½ç•¥æ³¨é‡Šã€‚å°½ç®¡æˆ‘ä»¬å¸Œæœ›æ³¨é‡Šéµå¾ªè¯­æ³•çº¦å®šâ€”â€”ä¾‹å¦‚ï¼Œå®ƒä»¬å¿…é¡»ä»¥ `//` å¼€å¤´å¹¶ä»¥æ¢è¡Œç¬¦ç»“å°¾â€”â€”ä½†æˆ‘ä»¬ä¸å¸Œæœ›å®ƒä»¬åœ¨å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°ã€‚å› æ­¤ï¼Œä¸ºäº†å¿½ç•¥æ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰å®ƒä»¬ï¼š

```
comments = _{ "//" ~ (!NEWLINE ~ ANY)* ~ NEWLINE }
```

è¿™å°†å°è¯•åŒ¹é…ä»»ä½•è¯„è®ºã€‚å¦‚æœå­˜åœ¨ä»»ä½•è¯­æ³•é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæ³¨é‡Šä»…ä»¥ä¸€ä¸ª `/` å¼€å¤´ï¼‰ï¼Œåˆ™ä¼šäº§ç”Ÿé”™è¯¯ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ³¨é‡ŠåŒ¹é…æˆåŠŸï¼Œè§£æå™¨å°†ä¸ä¼šä¸ºæ­¤è§„åˆ™ç”Ÿæˆå¯¹ã€‚

ç†è®ºä¸Šï¼Œè¯„è®ºå¯ä»¥å‡ºç°åœ¨ä»»ä½•åœ°æ–¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªè§„åˆ™çš„æœ«å°¾æ”¾ç½®ä¸€ä¸ª `comments?` ï¼Œè¿™å°†æ˜¯ä¹å‘³çš„ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒPest æä¾›äº†ä¸¤ä¸ªå›ºå®šçš„è§„åˆ™åç§° - `COMMENT` æˆ– `WHITESPACE` - ç”Ÿæˆçš„è§£æå™¨å°†è‡ªåŠ¨å…è®¸è¿™äº›è¡¨ç¤ºçš„æ³¨é‡Šæˆ–ç©ºæ ¼å­˜åœ¨äºè¾“å…¥ä¸­çš„ä»»ä½•ä½ç½®ã€‚å¦‚æœæˆ‘ä»¬å®šä¹‰ä»»ä¸€è§„åˆ™ï¼Œç”Ÿæˆçš„è§£æå™¨å°†éšå¼æ£€æŸ¥æ¯ä¸ª tilda `~` å’Œæ‰€æœ‰é‡å¤é¡¹ã€‚

å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¹¶ä¸æ€»æ˜¯æƒ³è¦è¿™ç§è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬ç¼–å†™éœ€è¦å…·æœ‰ç‰¹å®šæ•°é‡çš„ç©ºç™½çš„è§„åˆ™æ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½å…è®¸è¿™äº›éšå¼è§„åˆ™æ¶ˆè€—è¯¥ç©ºé—´ã€‚

ä½œä¸ºè§£å†³æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å·¦å¤§æ‹¬å· `{` æˆ–ç¾å…ƒ `$` ç¬¦å·æ¥å®šä¹‰åŸå­è§„åˆ™ï¼ˆä¸æ‰§è¡Œéšå¼åŒ¹é…ï¼‰ > å®šä¹‰è§„åˆ™æ—¶ã€‚ `@` ä½¿è§„åˆ™åŸå­åŒ–ä¸”é™é»˜ï¼Œè€Œ `$` å°†ä½¿è§„åˆ™åŸå­åŒ–å¹¶åƒä»»ä½•å…¶ä»–è§„åˆ™ä¸€æ ·ç”Ÿæˆä»¤ç‰Œã€‚

### å†…ç½®è¾“å…¥è§„åˆ™çš„å¼€å§‹å’Œç»“æŸ

`SOI` å’Œ `EOI` æ˜¯ä¸¤ä¸ªç‰¹æ®Šçš„å†…ç½®è§„åˆ™ï¼Œå®ƒä»¬ä¸åŒ¹é…ä»»ä½•å†…å®¹ï¼Œè€Œæ˜¯è¡¨ç¤ºè¾“å…¥çš„å¼€å§‹å’Œç»“æŸã€‚å½“æ‚¨æƒ³è¦ç¡®ä¿è§£ææ•´ä¸ªè¾“å…¥è€Œä¸æ˜¯å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…åœ¨è§„åˆ™å¼€å¤´å…è®¸ç©ºæ ¼å’Œæ³¨é‡Šæ—¶ï¼Œè¿™äº›éå¸¸æœ‰ç”¨ã€‚

ä»¥ä¸Šå†…å®¹åº”è¯¥æ¶µç›–äº†ç¼–å†™ PEG è§„åˆ™çš„é‡è¦åŸºç¡€çŸ¥è¯†ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨ Pest æ–‡æ¡£ä¸­æ‰¾åˆ°å®Œæ•´çš„è¯¦ç»†ä¿¡æ¯ã€‚ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬æ‰€å­¦åˆ°çš„çŸ¥è¯†æ„å»ºä¸€ä¸ªç¤ºä¾‹è§£æå™¨ï¼

## ä½¿ç”¨ Pest æ¼”ç¤ºä¸€ä¸ªç®€å•çš„è§£æå™¨

ä½¿ç”¨ Pest æ„å»ºè§£æå™¨ä½¿æ‚¨èƒ½å¤Ÿå®šä¹‰å’Œè§£æä»»ä½•è¯­æ³•ï¼ŒåŒ…æ‹¬ Rustã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªè§£æå™¨ï¼Œè¯¥è§£æå™¨å°†è§£æ HTML æ–‡æ¡£çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä»¥æä¾›ä¸æ ‡ç­¾å’Œå±æ€§ç›¸å…³çš„ä¿¡æ¯ä»¥åŠå®é™…æ–‡æœ¬ã€‚

æˆ‘ä»¬çš„ç¤ºä¾‹ä½¿ç”¨ HTMLï¼Œå› ä¸ºå®ƒçš„è¯­æ³•ä¼—æ‰€å‘¨çŸ¥å¹¶æ˜“äºç†è§£ï¼Œä¸éœ€è¦å¤§é‡è§£é‡Šï¼Œè€Œä¸”è¿˜æä¾›äº†è¶³å¤Ÿçš„å¤æ‚æ€§ï¼Œä½¿æˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºè§£ææ—¶éœ€è¦è€ƒè™‘çš„ä¸åŒå†…å®¹ã€‚å­¦ä¹ è¿™äº›åŸºç¡€çŸ¥è¯†åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„çŸ¥è¯†æ¥å®šä¹‰å’Œè§£ææ‚¨é€‰æ‹©çš„ä»»ä½•è¯­æ³•ã€‚

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®å¹¶æ·»åŠ  `pest` å’Œ `pest_derive` ä½œä¸ºä¾èµ–é¡¹ã€‚

Pest éå¸¸é‡è§†å°†è§„åˆ™å’Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç åˆ†å¼€ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­å®šä¹‰è§„åˆ™ï¼Œå¹¶ä½¿ç”¨ Pest ç®±ç»™å‡ºçš„å®åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­æ„å»ºå’Œå¯¼å…¥è§£æå™¨ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åœ¨ `src` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º `html.pest` çš„æ–‡ä»¶ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬é¦–å…ˆå°† `tag` å®šä¹‰ä¸ºè§„åˆ™ã€‚æ ‡ç­¾ä»¥å°äº `<` ç¬¦å·å¼€å¤´ï¼Œç´§è·Ÿé›¶ä¸ªæˆ–ä¸€ä¸ªæ­£æ–œæ  `/` ï¼Œç„¶åæ˜¯æ ‡ç­¾åç§°ï¼Œä»¥ `>` æˆ– `/>` ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é—®å· `?` æ¥æ£€æµ‹å¯é€‰çš„ `/` å¹¶å®šä¹‰è§„åˆ™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
tag = ${ "<" ~ "/"? ~ ASCII_ALPHA+ ~ "/"? ~ ">" }
```

è¯¥è§„åˆ™æ˜¯åŸå­çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›å°äºå· `<` å’Œæ ‡ç­¾åç§°ä¹‹é—´æœ‰ç©ºæ ¼ã€‚ç›®å‰ï¼Œè¿™è¿˜å…è®¸åƒ `</abc/>` è¿™æ ·çš„æ ‡ç­¾â€”â€”è¿™æ˜¯æ— æ•ˆçš„ HTMLâ€”â€”ä½†æˆ‘ä»¬ç¨åä¼šå¤„ç†è¿™ä¸ªé—®é¢˜ã€‚ç”±äºæ ‡ç­¾åç§°ä¸èƒ½ä¸ºç©ºï¼Œå› æ­¤åœ¨åŒ¹é…å­—æ¯æ—¶æˆ‘ä»¬ä½¿ç”¨åŠ å· `+` ã€‚

ä¸‹é¢æˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ª `document` è§„åˆ™ï¼Œå®ƒåŒ…å«å¤šä¸ªæ ‡ç­¾å¹¶å…è®¸å®ƒä»¬ä¹‹é—´æœ‰ç©ºæ ¼ï¼š

```
document = { SOI ~ tag+ ~ EOI}
```

æˆ‘ä»¬ä½¿ç”¨äº†åŠ å· `+` ç¬¦å·ï¼Œå› ä¸ºæ–‡æ¡£åº”è¯¥è‡³å°‘æœ‰ä¸€ä¸ªæ ‡ç­¾ã€‚

æœ€åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª `WHITESPACE` è§„åˆ™æ¥å…è®¸æ ‡ç­¾ä¹‹é—´æœ‰ç©ºæ ¼å’Œæ¢è¡Œç¬¦ï¼š

```
WHITESPACE = _{ " " | NEWLINE }
```

è¦å®é™…æ„å»ºå¹¶å°†å…¶å¯¼å…¥åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä»¥ä¸‹å‘½ä»¤ï¼š

```rust
use pest_derive::Parser;

#[derive(Parser)]
#[grammar = "html.pest"]
pub struct HtmlParser;
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¼å…¥æ´¾ç”Ÿè§£æå™¨æ‰€éœ€çš„å®ã€‚ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰äº†åä¸º `HtmlParser` çš„è§£æå™¨ç»“æ„ï¼Œç”¨ `#[derive(Parser)]` å¯¹å…¶è¿›è¡Œæ ‡è®°ï¼Œå¹¶ä¸ºå…¶æä¾›å…¶ä¸­æ–‡ä»¶çš„åç§°ã€‚æˆ‘ä»¬ä½¿ç”¨ `grammar =` æŒ‡ä»¤å®šä¹‰äº†æˆ‘ä»¬çš„è§„åˆ™ã€‚

è¦æŸ¥çœ‹å®ƒå½“å‰çš„åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬è¿›è¡Œä»¥ä¸‹è®¾ç½®ï¼š

```rust
const HTML:&str = "<html> </html>";

fn main() {
    // parse the input using the rule 'document'
    let parse = HtmlParser::parse(Rule::document, HTML).unwrap();
    // make an iterator over the pairs in the rule
    for pair in parse.into_iter(){
        // match the rule, as the rule is an enum
        match pair.as_rule(){
            Rule::document =>{
                // for each sub-rule, print the inner contents
                for tag in pair.into_inner(){
                    println!("{:?}",tag);
                }
            }
            // as we have  parsed document, which is a top level rule, there
            // cannot be anything else
            _ => unreachable!()
        }
    }
}
```

ä»¥ä¸Šå°†äº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š

```
Pair { rule: tag, span: Span { str: "<html>", start: 0, end: 6 }, inner: [] }
Pair { rule: tag, span: Span { str: "</html>", start: 7, end: 14 }, inner: [] }
Pair { rule: EOI, span: Span { str: "", start: 14, end: 14 }, inner: [] }
```

è¿™è¡¨æ˜ç¬¬ä¸€ä¸ªåŒ¹é…æ˜¯ `<html>` æ ‡è®°ï¼Œç„¶åæ˜¯ `</html>` æ ‡è®°ï¼Œæœ€åæ˜¯è¾“å…¥ç»“æŸã€‚

è®©æˆ‘ä»¬å°è¯•æ·»åŠ æ›´å¤šæ ‡ç­¾ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼š

```rust
const HTML:&str = "<html> <head> </head> <body></body> </html>";
```

ç»“æœåº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š

```
Pair { rule: tag, span: Span { str: "<html>", start: 0, end: 6 }, inner: [] }
Pair { rule: tag, span: Span { str: "<head>", start: 7, end: 13 }, inner: [] }
Pair { rule: tag, span: Span { str: "</head>", start: 14, end: 21 }, inner: [] }
Pair { rule: tag, span: Span { str: "<body>", start: 22, end: 28 }, inner: [] }
Pair { rule: tag, span: Span { str: "</body>", start: 28, end: 35 }, inner: [] }
Pair { rule: tag, span: Span { str: "</html>", start: 36, end: 43 }, inner: [] }
Pair { rule: EOI, span: Span { str: "", start: 43, end: 43 }, inner: [] }
```

å®ƒæ­£ç¡®è¯†åˆ«æ‰€æœ‰æ ‡ç­¾ğŸ‰

ç°åœ¨è®©æˆ‘ä»¬æ‰©å±•å®ƒä»¥å…è®¸æ ‡ç­¾å†…æœ‰æ–‡æœ¬ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ `text` ï¼Œè¿™å¯èƒ½å¾ˆæ£˜æ‰‹ã€‚ä¸ºä»€ä¹ˆï¼Ÿè€ƒè™‘ä»¥ä¸‹è¾“å…¥ï¼š

```
<start> abc < def > </end>
```

æœ‰äº†ä¸Šé¢çš„å†…å®¹ï¼Œå¦‚æœæˆ‘ä»¬å°† `text` å®šä¹‰ä¸º `ANY+` ï¼Œå®ƒå°†åå™¬ `abc` å­—ç¬¦ä¸²ä¸­ä» `a` å­—ç¬¦å¼€å§‹çš„æ‰€æœ‰å†…å®¹åˆ°å¹¶åŒ…æ‹¬ `</end>` ã€‚

å¦‚æœæˆ‘ä»¬å°† `text` å®šä¹‰ä¸º `ASCII_ALPHANUMERIC` ï¼Œè¿™å°†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä½†å®ƒä¼šåœ¨ `abc` ç¬¦å·ä¸Šç»™æˆ‘ä»¬ä¸€ä¸ªé”™è¯¯/b3> å­—ç¬¦ä¸²ï¼Œå› ä¸ºè§£æå™¨å¸Œæœ›å®ƒæ˜¯æ ‡ç­¾çš„å¼€å¤´ã€‚

ä¸ºäº†å…‹æœè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å®šä¹‰ `text` å¦‚ä¸‹ï¼š

```
document = { SOI ~ ( tag ~ text?)* ~ EOI }
...
text = { (ASCII_ALPHANUMERIC | other_symbols | non_tag_start | WHITESPACE )+ }
non_tag_start = ${ "<" ~ WHITESPACE+}
other_symbols = { ">" |"@" | ";" | "," }
```

ç°åœ¨ï¼Œ `text` è¢«å®šä¹‰ä¸ºé‡å¤ä¸€æ¬¡æˆ–å¤šæ¬¡çš„ä»»ä½•å­—æ¯æ•°å­—å­—ç¬¦ OR `other_symbols` OR `non_tag_start` OR `WHITESPACE` ã€‚

`other_symbol` è§„åˆ™è´Ÿè´£å¤„ç†æˆ‘ä»¬æƒ³è¦åŒ…å«çš„ä»»ä½•éå­—æ¯æ•°å­—ç¬¦å·ã€‚åŒæ—¶ï¼Œ `non_tag_start` æ˜¯ä¸€ä¸ªåŸå­è§„åˆ™ï¼Œå®ƒåŒ¹é…ä¸¥æ ¼åè·Ÿä¸€ä¸ªæˆ–å¤šä¸ªç©ºæ ¼çš„ `<` ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±é™åˆ¶äº†æˆ‘ä»¬è®¤ä¸ºæ˜¯æ–‡æœ¬çš„å†…å®¹ã€‚æˆ‘ä»¬è¿˜è¢«è¿«åœ¨æ ‡ç­¾å¼€å§‹ç¬¦å· `<` å’Œæ ‡ç­¾åç§°ä¹‹é—´ä¸ç•™ä»»ä½•ç©ºæ ¼ã€‚è¿™å¯¹äºæˆ‘ä»¬çš„ä¾‹å­æ¥è¯´æ˜¯å¯è¡Œçš„ã€‚

ç°åœ¨ï¼Œè€ƒè™‘ä»¥ä¸‹è¾“å…¥ï¼š

```rust
const HTML:&str = "<html> <head> </head> <body> < def > </body> </html>";
```

æˆ‘ä»¬ä¼šå¾—åˆ°è¿™äº›ç»“æœï¼š

```
Pair { rule: tag, span: Span { str: "<html>", start: 0, end: 6 }, inner: [] }
Pair { rule: tag, span: Span { str: "<head>", start: 7, end: 13 }, inner: [] }
Pair { rule: tag, span: Span { str: "</head>", start: 14, end: 21 }, inner: [] }
Pair { rule: tag, span: Span { str: "<body>", start: 22, end: 28 }, inner: [] }
Pair { rule: text, span: Span { str: "< def >", start: 29, end: 36 }, inner: [...] }
Pair { rule: tag, span: Span { str: "</body>", start: 37, end: 44 }, inner: [] }
Pair { rule: tag, span: Span { str: "</html>", start: 45, end: 52 }, inner: [] }
Pair { rule: EOI, span: Span { str: "", start: 52, end: 52 }, inner: [] }
```

è¿™æ­£æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ã€‚

æœ€åï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ ‡ç­¾ä¸­å¼•å…¥å±æ€§ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å¼€å§‹å°†å…¶è§£æä¸ºæ–‡æ¡£ç»“æ„ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°† `attr` å®šä¹‰ä¸ºä¸€ä¸ªæˆ–å¤šä¸ª `ASCII_ALPHA` å­—ç¬¦ï¼Œåè·Ÿ `=` ï¼Œç„¶åæ˜¯å¸¦å¼•å·çš„æ–‡æœ¬ï¼š

```
attr = { ASCII_ALPHA+ ~ "=" ~ "\"" ~ text ~ "\""}
```

æˆ‘ä»¬è¿˜å°†ä¿®æ”¹ `tag` ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
tag = ${ "<" ~ "/"? ~ ASCII_ALPHA+ ~ (WHITESPACE+ ~ attr)* ~ "/"? ~ ">" }
```

å¦‚æœæˆ‘ä»¬åœ¨ä»¥ä¸‹å†…å®¹ä¸Šè¿è¡Œå®ƒï¼Œæˆ‘ä»¬å·²å°†å…¶è½¬æ¢ä¸ºåŸå§‹å­—ç¬¦ä¸²ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…è½¬ä¹‰å¼•å·ï¼š

```rust
const HTML:&str = r#"<html lang=" en"> <head> </head> <body> < def > </body> </html>"#;
```

æˆ‘ä»¬å°†å¾—åˆ°é¢„æœŸçš„è¾“å‡ºï¼š

```
Pair { rule: tag, span: Span { str: "<html lang=\" en\">", start: 0, end: 17 }, inner: [Pair { rule: attr, span: Span { str: "lang=\" en\"", start: 6, end: 16 }, inner: [Pair { rule: text, span: Span { str: " en", start: 12, end: 15 }, inner: [] }] }] }
Pair { rule: tag, span: Span { str: "<head>", start: 18, end: 24 }, inner: [] }
Pair { rule: tag, span: Span { str: "</head>", start: 25, end: 32 }, inner: [] }
Pair { rule: tag, span: Span { str: "<body>", start: 33, end: 39 }, inner: [] }
Pair { rule: text, span: Span { str: "< def >", start: 40, end: 47 }, inner: [...] }
Pair { rule: tag, span: Span { str: "</body>", start: 48, end: 55 }, inner: [] }
Pair { rule: tag, span: Span { str: "</html>", start: 56, end: 63 }, inner: [] }
Pair { rule: EOI, span: Span { str: "", start: 63, end: 63 }, inner: [] }
```

æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œç¬¬ä¸€å¯¹çš„ `inner` å­—æ®µåŒ…å« `attr` è§„åˆ™ã€‚

ä¸ºäº†å¸®åŠ©æˆ‘ä»¬ç¡®å®šæ–‡æ¡£çš„ç»“æ„ã€æ ‡ç­¾çš„åµŒå¥—ç­‰ï¼Œæˆ‘ä»¬å°†åƒè¿™æ ·åˆ†å¼€ `start_tag` ã€ `end_tag` å’Œ `self_closing_tag` å®šä¹‰ï¼š

```
tag = ${ start_tag | self_closing_tag | end_tag }
start_tag = { "<" ~ ASCII_ALPHA+ ~ (WHITESPACE+ ~ attr)* ~ ">" }
end_tag = { "</" ~ ASCII_ALPHA+ ~ (WHITESPACE+ ~ attr)* ~ ">" }
self_closing_tag = { "<" ~ ASCII_ALPHA+ ~ (WHITESPACE+ ~ attr)* ~ "/>" }
```

è¯·æ³¨æ„ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ”¹ `tag` å®šä¹‰çš„é¡ºåºï¼Œå› ä¸ºå®ƒä»¬æ˜¯äº’æ–¥çš„ï¼Œè¿™æ„å‘³ç€ä»»ä½• `start_tag` éƒ½ä¸èƒ½æ˜¯ `self_closing_tag` ç­‰ç­‰ã€‚

ä¸ºäº†æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹è¾“å…¥ï¼š

```rust
const HTML:&str = r#"<html lang="en"> <head> </head> <body> <div class="c1" id="id1"> <img src="path"/> </div> </body> </html>"#;
```

é¢„æœŸè¾“å‡ºå¦‚ä¸‹ï¼Œä½†è¯·æ³¨æ„ï¼Œå®ƒæ˜¯æ‰‹åŠ¨æ ¼å¼åŒ–çš„ï¼Œå¹¶ä¸”ä¸ºäº†æ›´å¥½çš„å¯è¯»æ€§ï¼Œå¼€å§‹å’Œç»“æŸä½ç½®å·²è¢«æˆªæ–­ï¼š

```
Pair { rule: tag, span: Span { str: "<html lang=\"en\">" ... }, 
  inner: [Pair { rule: start_tag, span: Span { str: "<html lang=\"en\">" ...}, 
    inner: [Pair { rule: attr, span: Span { str: "lang=\"en\"" ... }, 
      inner: [Pair { rule: text, span: Span { str: "en"}, inner: [] }] }] }] }

Pair { rule: tag, span: Span { str: "<head>" ... }, 
  inner: [Pair { rule: start_tag, span: Span { str: "<head>" ... }, inner: [] }] }

Pair { rule: tag, span: Span { str: "</head>" ... }, 
  inner: [Pair { rule: end_tag, span: Span { str: "</head>" ... }, inner: [] }] }

Pair { rule: tag, span: Span { str: "<body>" ... }, 
  inner: [Pair { rule: start_tag, span: Span { str: "<body>" ... }, inner: [] }] }

Pair { rule: tag, span: Span { str: "<div class=\"c1\" id=\"id1\">" ... }, 
  inner: [Pair { rule: start_tag, span: Span { str: "<div class=\"c1\" id=\"id1\">" ...}, 
    inner: [Pair { rule: attr, span: Span { str: "class=\"c1\"" ... }, 
      inner: [Pair { rule: text, span: Span { str: "c1" ... }, inner: [] }] }, 
  Pair { rule: attr, span: Span { str: "id=\"id1\"" ... }, 
      inner: [Pair { rule: text, span: Span { str: "id1" ... }, inner: [] }] }] }] }

Pair { rule: tag, span: Span { str: "<img src=\"path\"/>" ... }, 
  inner: [Pair { rule: self_closing_tag, span: Span { str: "<img src=\"path\"/>"...},
    inner: [Pair { rule: attr, span: Span { str: "src=\"path\"" ... }, 
      inner: [Pair { rule: text, span: Span { str: "path" ... }, inner: [] }] }] }] }

Pair { rule: tag, span: Span { str: "</div>" ...}, 
  inner: [Pair { rule: end_tag, span: Span { str: "</div>" ... }, inner: [] }] }

Pair { rule: tag, span: Span { str: "</body>" ...}, 
  inner: [Pair { rule: end_tag, span: Span { str: "</body>" ...}, inner: [] }] }

Pair { rule: tag, span: Span { str: "</html>" ...}, 
  inner: [Pair { rule: end_tag, span: Span { str: "</html>" ... }, inner: [] }] }

Pair { rule: EOI, span: Span { str: "" ... }, inner: [] }
```

æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œæ¯ä¸ªæ ‡ç­¾éƒ½è¢«æ­£ç¡®æ ‡è¯†ä¸º `start_tag` æˆ– `end_tag` ï¼Œä½† `img` æ ‡ç­¾é™¤å¤–ï¼Œå®ƒè¢«æ ‡è¯†ä¸º `self_closing_tag` ã€‚

ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨è¿™äº›æ ‡è®°æ¥æ„å»ºæ–‡æ¡£æ ‘ç»“æ„ã€‚è¯¥é¡¹ç›®çš„ GitHub å­˜å‚¨åº“å®ç°äº†å°†å…¶è½¬æ¢ä¸ºæ ‘ç»“æ„çš„ä»£ç ã€‚è¿™æ®µä»£ç å¯ä»¥è§£æä»¥ä¸‹å†…å®¹ï¼š

```rust
<html lang="en" l="abc"> 
<head> 
</head> 
<body> 
    <div class="c1" id="id1"> 
        Hello 
        <img src="path"/> 
    </div> 
    <div>
        <p>
            <p>
                abc
    </div>
    <p>
        jkl
    </p>
    <img/>
    </p> 
    </div>
</body> 
</html>
```

ç„¶åå®ƒå¯ä»¥æ‰“å°å±‚æ¬¡ç»“æ„ï¼Œå…¶åº”ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š

```
- html
  - head
  - body
    - div
      - text(Hello)
      - img
    - div
      - p
        - p
          - text(abc)
    - p
      - text(jkl)
    - img
```

## ä¸º Rust æˆ–æ‚¨è‡ªå·±çš„è¯­è¨€ç¼–å†™è§£æå™¨

ä½¿ç”¨æˆ‘ä»¬åœ¨å‰é¢å‡ èŠ‚ä¸­çœ‹åˆ°çš„æ¦‚å¿µï¼Œæ‚¨å¯ä»¥ä¸ºç°æœ‰è¯­è¨€ç¼–å†™ç±»ä¼¼çš„è§£æå™¨ï¼Œæˆ–è€…å®šä¹‰è‡ªå·±çš„è¯­æ³•å¹¶ä¸ºæ‚¨è‡ªå·±çš„è¯­è¨€ç¼–å†™è§£æå™¨ã€‚

ä½œä¸ºä¸€ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸º Rust è¯­æ³•çš„å­é›†ç¼–å†™ä¸€ä¸ªè§£æå™¨ã€‚ç”±äºä¸º Rust ç¼–å†™å®Œæ•´çš„è§£æå™¨æœ¬è´¨ä¸Šæ˜¯ä¸º Rust ç¼–è¯‘å™¨ç¼–å†™å‰ç«¯ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šåœ¨è¿™é‡Œä»‹ç»å®Œæ•´çš„è¯­æ³•ï¼Œä¹Ÿä¸ä¼šæ˜¾ç¤ºè¯¦ç»†çš„ä»£ç ç¤ºä¾‹ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬è€ƒè™‘å†…ç½®ç±»å‹å’Œå…³é”®å­—ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºè¿™äº›å­—ç¬¦ä¸²ç¼–å†™è§£æè§„åˆ™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
LET_KW = { "let" }
FOR_KW = { "for" }
...
U8_TYP = { "u8" }
I8_TYP = { "i8" }
...
TYPES = { U8_TYP | I8_TYP | ..}
```

å®Œæˆæ­¤æ“ä½œåï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºåŒ…å« `ASCII_ALPHA` å­—ç¬¦ã€ `ASCII_DIGIT` å­—ç¬¦å’Œä¸‹åˆ’çº¿ `_` ç¬¦å·çš„å­—ç¬¦é›†åˆå®šä¹‰ä¸€ä¸ªå˜é‡åç§°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
VAR_NAME = @{ ("_"|ASCII_ALPHA)~(ASCII_ALPHA | ASCII_DIGIT | "_")* }
```

è¿™å°†å…è®¸å˜é‡åç§°ä»¥ä¸‹åˆ’çº¿æˆ–å­—æ¯å­—ç¬¦å¼€å¤´ï¼Œå¹¶ä¸”åç§°å¯ä»¥åŒ…å«å­—æ¯å­—ç¬¦ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿ã€‚

ä¹‹åï¼Œå®šä¹‰ä¸€ä¸ª let è¡¨è¾¾å¼æ¥å£°æ˜ä¸€ä¸ªæ²¡æœ‰å€¼çš„å˜é‡å°±å¾ˆç®€å•äº† â€“

```
VAR_DECL = {LET_KW ~ VAR_NAME ~ (":" ~ TYPES)? ~ ("=" ~ VALUE)?~ ";"}
```

æˆ‘ä»¬ä» `let` å…³é”®å­—å¼€å§‹ï¼Œåé¢æ˜¯å˜é‡åç§°ï¼Œç„¶åæ˜¯å¯é€‰çš„å˜é‡ç±»å‹å’Œè¦åˆ†é…çš„å¯é€‰å€¼ï¼ˆä»¥å¿…éœ€çš„åˆ†å·ç»“å°¾ï¼‰ã€‚è¯¥å€¼æœ¬èº«å¯ä»¥å®šä¹‰ä¸ºæ•°å­—ã€å­—ç¬¦ä¸²æˆ–å¦ä¸€ä¸ªå˜é‡ï¼š

```
VALUE = { NUMBER | STRING | VAR_NAME }
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰æ”¯æŒçš„ç»“æ„å¹¶è§£æä»»ä½•è¯­è¨€çš„è¯­æ³•ã€‚

é™¤äº† Rust çš„è¯­æ³•ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å®šä¹‰è‡ªå®šä¹‰è¯­æ³•ï¼š

```
VAR_DECL = { "let there be" VAR_NAME ~( "which stores" ~ TYPES )? ~ ("which is equal to" ~ VALUE)? "." }
```

è¿™å°†å…è®¸æˆ‘ä»¬ä»¥ä»¥ä¸‹æ ¼å¼å£°æ˜å˜é‡ï¼š

```
let there be num which stores i8 which is equal to 5.
let there be counter which is equal to 7.
let there be greeting which stores string.
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰è‡ªå·±çš„è¯­æ³•å’Œæ–‡æ³•ï¼Œä½¿ç”¨Pestè¿›è¡Œè§£æï¼Œæ„å»ºè‡ªå·±çš„è¯­è¨€ã€‚

##  ç»“è®º

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨è§£æå™¨ç”Ÿæˆå™¨æ¥ç”Ÿæˆè§£æå™¨è€Œä¸æ˜¯æ‰‹åŠ¨ç¼–å†™å®ƒä»¬ã€‚æˆ‘ä»¬è¿˜æ¢ç´¢äº† Pest è§£æå™¨ç”Ÿæˆå™¨å¹¶ä½¿ç”¨ PEGã€‚æœ€åï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸€ä¸ªç¤ºä¾‹ Rust è§£æå™¨é¡¹ç›®ï¼Œä½¿ç”¨ Pest æ¥è§£æç®€åŒ–çš„ HTML æ–‡æ¡£çš„è¯­æ³•ã€‚

ç›¸å…³ä»£ç ï¼ˆåŒ…æ‹¬æ„å»ºæ–‡æ¡£ç»“æ„ï¼‰å¯ä»¥åœ¨[æˆ‘çš„ GitHub å­˜å‚¨åº“](https://github.com/YJDoc2/LogRocket-Blog-Code/tree/main/parser-with-pest)ä¸­æ‰¾åˆ°ã€‚è°¢è°¢é˜…è¯»ï¼



> ä¸‹é¢æ˜¯ä¸€äº›å‚è€ƒèµ„æ–™å’Œå·¥å…·ï¼š
>
> + [é™ˆå¤©.å†æ¢ Parser å’Œ Parse Combinator](https://zhuanlan.zhihu.com/p/355364928)
> + https://pest.rs/book/
> + https://github.com/pest-parser/awesome-pest