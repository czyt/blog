<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>golang | 虫子樱桃</title>
<meta name="keywords" content="" />
<meta name="description" content="我来问道无馀说，云在青天水在瓶。">
<meta name="author" content="czyt">
<link rel="canonical" href="https://czyt.tech/tags/golang/" />
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.2300a0eceb56958fe6e1d606ffa0a755d9ef95657cbf4b79a3fa1d3b9dc8b654.css" integrity="sha256-IwCg7OtWlY/m4dYG/6CnVdnvlWV8v0t5o/odO53ItlQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://czyt.tech/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://czyt.tech/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://czyt.tech/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://czyt.tech/apple-touch-icon.png">
<link rel="mask-icon" href="https://czyt.tech/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.105.0">
<link rel="alternate" type="application/rss+xml" href="https://czyt.tech/tags/golang/index.xml">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="golang" />
<meta property="og:description" content="我来问道无馀说，云在青天水在瓶。" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://czyt.tech/tags/golang/" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="golang"/>
<meta name="twitter:description" content="我来问道无馀说，云在青天水在瓶。"/>

</head>

<body class="list" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://czyt.tech/" accesskey="h" title="虫子樱桃 (Alt + H)">虫子樱桃</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://czyt.tech/" title="🏠Home">
                    <span>🏠Home</span>
                </a>
            </li>
            <li>
                <a href="https://czyt.tech/about/" title="🙋About">
                    <span>🙋About</span>
                </a>
            </li>
            <li>
                <a href="https://czyt.tech/post/" title="📚Posts">
                    <span>📚Posts</span>
                </a>
            </li>
            <li>
                <a href="https://czyt.tech/search/" title="🔍Search">
                    <span>🔍Search</span>
                </a>
            </li>
            <li>
                <a href="https://czyt.tech/tags/" title="🔖Tags">
                    <span>🔖Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main"> 
<header class="page-header"><div class="breadcrumbs"><a href="https://czyt.tech/">Home</a>&nbsp;»&nbsp;<a href="https://czyt.tech/tags/">Tags</a></div>
  <h1>golang</h1>
</header>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>使用protoc-gen-star编写protoc插件
    </h2>
  </header>
  <section class="entry-content">
    <p>预备知识 需要安装的软件 protoc golang go 软件包 github.com/lyft/protoc-gen-star 插件调用步骤 protoc，PB编译器，使用一组标志（记录在protoc -h下）进行配置，并将一组文件作为参数交给它。在这种情况下，I标志可以被多次指定，是它在proto文件中用于导入依赖关系的查找路径。默认情况下，官方描述符protos已经被包含在内。
myplugin_out 告诉 protoc 使用 protoc-gen-myplugin protoc-plugin。这些插件会从系统的 PATH 环境变量中自动解析，或者可以用另一个标志明确指定。官方的protoc-plugins (例如，protoc-gen-python) 已经在protoc注册了。该标志的值是特定于特定插件的，但 :…/generated 后缀除外。这个后缀表示protoc将把该包生成的文件放在哪个根目录下（相对于当前工作目录）。然而，这个生成的输出目录不会传播给 protoc-gen-myplugin，所以它需要在标志的左边重复。PG* 通过一个 output_path 参数支持这一点。
protoc 解析传入的 proto 文件，确保它们在语法上是正确的，并加载任何导入的依赖项。它将这些文件和依赖关系转换成描述符 (它们本身就是 PB 消息)，并创建一个 CodeGeneratorRequest (又是一个 PB)。protoc 将这个请求序列化，然后执行每个配置的 protoc-plugin，通过 stdin 发送有效载荷。
protoc-gen-myplugin 启动，接收请求的有效载荷，并将其解密。一个基于 PG* 的 protoc-plugin 有两个阶段。首先，PG* 对从 protoc 收到的 CodeGeneratorRequest 进行解密，并为每个文件和其包含的所有实体创建一个完全连接的抽象语法树 (AST)。为这个插件指定的任何参数也会被解析，以便以后使用。
当这一步完成后，PG*就会执行任何注册的模块，把构建的AST交给它。模块可以被写成生成人工制品（例如，文件），或者只是对所提供的图进行某种形式的验证而没有任何其他副作用。模块在针对PB的操作方面提供了极大的灵活性。
一旦所有的模块都被运行，PG*会将任何自定义的工件写入文件系统，或者将生成器特定的工件序列化为CodeGeneratorResponse并将数据发送到其stdout。这整个流程看起来像这样。
foo.proto → protoc → CodeGeneratorRequest → protoc-gen-myplugin → CodeGeneratorResponse → protoc → foo.pb.go 假设插件名称为diy,则需要编译程序为protoc-gen-diy，并将程序加入系统Path变量，通过下面的命令调用插件。
protoc -I ....</p>
  </section>
  <footer class="entry-footer"><span title='2022-10-29 00:00:00 +0000 UTC'>October 29, 2022</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to 使用protoc-gen-star编写protoc插件" href="https://czyt.tech/post/writing-a-protoc-plugin-using-protoc-gen-star/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>tailscale的泛型SingleFlight
    </h2>
  </header>
  <section class="entry-content">
    <p>源地址 tailscale仓库
完整代码如下
// Copyright (c) 2022 Tailscale Inc &amp; AUTHORS All rights reserved. // Use of this source code is governed by a BSD-style // license that can be found in the LICENSE file. // Copyright 2013 The Go Authors. All rights reserved. // Use of this source code is governed by a BSD-style // license that can be found in the LICENSE file. // Package singleflight provides a duplicate function call suppression // mechanism....</p>
  </section>
  <footer class="entry-footer"><span title='2022-09-23 00:00:00 +0000 UTC'>September 23, 2022</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to tailscale的泛型SingleFlight" href="https://czyt.tech/post/generic-singleflight-by-tailscale/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>Golang 默认的CGO参数编译导致的GLIBC错误
    </h2>
  </header>
  <section class="entry-content">
    <p>问题描述 使用go正常编译了Linux下的程序，放到服务器上报错
./app: /lib64/libc.so.6: version `GLIBC_2.34&#39; not found (required by ./app) 解决 Google了下，发现相同的Issue,于是通过go env检查本机golang运行环境，发现CGO默认启用而且程序也不涉及CGO相关的东西，于是设置CGO参数为关闭。然后编译程序
CGO_ENABLED=&#34;0&#34; go build -v
重新上传，运行OK.</p>
  </section>
  <footer class="entry-footer"><span title='2022-08-30 00:00:00 +0000 UTC'>August 30, 2022</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to Golang 默认的CGO参数编译导致的GLIBC错误" href="https://czyt.tech/post/golang-default-cgo-flags-caused-glibc-missing-error/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>golang http客户端使用自定义dns
    </h2>
  </header>
  <section class="entry-content">
    <p>摘自互联网 原文
package main import ( &#34;context&#34; &#34;io/ioutil&#34; &#34;log&#34; &#34;net&#34; &#34;net/http&#34; &#34;time&#34; ) func main() { var ( dnsResolverIP = &#34;8.8.8.8:53&#34; // Google DNS resolver. dnsResolverProto = &#34;udp&#34; // Protocol to use for the DNS resolver dnsResolverTimeoutMs = 5000 // Timeout (ms) for the DNS resolver (optional) ) dialer := &amp;net.Dialer{ Resolver: &amp;net.Resolver{ PreferGo: true, Dial: func(ctx context.Context, network, address string) (net.Conn, error) { d := net.Dialer{ Timeout: time.Duration(dnsResolverTimeoutMs) * time....</p>
  </section>
  <footer class="entry-footer"><span title='2022-08-22 00:00:00 +0000 UTC'>August 22, 2022</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to golang http客户端使用自定义dns" href="https://czyt.tech/post/golang-http-use-custom-dns/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>go-kratos使用备忘
    </h2>
  </header>
  <section class="entry-content">
    <p>自定义接口返回内容 正常的响应序列化逻辑通过Response Encoder实现。
错误的序列化逻辑通过ErrorEncoder实现。
注意：自定义Encoder后，可能会遇到零值字段被忽略的情况，可以参考这个issue。具体的解决办法是
proto定义返回内容，然后将生成的类型在encoder中使用。
简单代码大致如下：
proto定义
import &#34;google/protobuf/any.proto&#34;; // BaseResponse is the base response message BaseResponse{ int32 code = 1 [json_name = &#34;code&#34;]; google.protobuf.Any data = 2 [json_name = &#34;data&#34;]; } go代码
func CustomResponseEncoder() http.ServerOption { return http.ResponseEncoder(func(w http.ResponseWriter, r *http.Request, i interface{}) error { reply := &amp;v1.BaseResponse{ Code: 0, } if m, ok := i.(proto.Message); ok { payload, err := anypb.New(m) if err != nil { return err } reply....</p>
  </section>
  <footer class="entry-footer"><span title='2022-08-12 00:00:00 +0000 UTC'>August 12, 2022</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to go-kratos使用备忘" href="https://czyt.tech/post/go-kratos-usage-memo/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>Protobuf golang小札
    </h2>
  </header>
  <section class="entry-content">
    <p>Oneof 如果您有许多字段的消息，并且最多可以同时设置一个字段，则可以使用Oneof功能来执行此行为并保存内存。一个字段就像常规字段一样，除了单一共享内存中的所有字段，最多可以同时设置一个字段。设置Oneof的任何成员都会自动清除所有其他成员。
​	Google protobuf 文档#Oneof
示例proto 创建protoOneof.proto 的proto文件
syntax = &#34;proto3&#34;; package oneof_test; option go_package =&#39;.;oneof&#39;; message WeiboUser{ string user_id = 1; string user_nick = 2; } message DouyinUser{ string auth_token = 1; string nick_name = 2; } message User{ oneof user_source{ string weibo_url = 1; string douyin_url = 2; } oneof user_info{ WeiboUser weibo_user_info = 3; DouyinUser douyin_user_info = 4; } } 使用命令生成go代码
protoc --proto_path=. --go_out=paths=source_relative:./oneof ./protoOneof.proto 生成的protoOneof.pb.go代码如下：...</p>
  </section>
  <footer class="entry-footer"><span title='2022-07-25 00:00:00 +0000 UTC'>July 25, 2022</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to Protobuf golang小札" href="https://czyt.tech/post/protobuf-golang-litle-notes/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>使用gotests生成表驱动测试
    </h2>
  </header>
  <section class="entry-content">
    <p>使用gotests可以很方便的生成表驱动测试代码，表驱动测试的具体内容，请参考go官方的wiki。下面是具体的使用方法。
安装 使用下面命令进行安装
go install github.com/cweill/gotests/gotests@latest 如果是go1.16之前的版本，可以使用命令 go get -u github.com/cweill/gotests/...来进行安装。
使用 gotests支持的参数如下：
Usage of C:\Users\czyt\go\bin\gotests.exe:-allgenerate tests for all functions and methods-excl stringregexp. generate tests for functions and methods that don&#39;t match. Takes precedence over -only, -exported, and -all-exportedgenerate tests for exported functions and methods. Takes precedence over -only and -all-i print test inputs in error messages-nosubtestsdisable generating tests using the Go 1....</p>
  </section>
  <footer class="entry-footer"><span title='2022-07-22 00:00:00 +0000 UTC'>July 22, 2022</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to 使用gotests生成表驱动测试" href="https://czyt.tech/post/use-gotests-to-generate-table-driven-tests/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>Golang Expr不完全指南
    </h2>
  </header>
  <section class="entry-content">
    <p>安装 库的说明
Expr package provides an engine that can compile and evaluate expressions. An expression is a one-liner that returns a value (mostly, but not limited to, booleans). It is designed for simplicity, speed and safety.
The purpose of the package is to allow users to use expressions inside configuration for more complex logic. It is a perfect candidate for the foundation of a business rule engine.
安装
go get -u /github....</p>
  </section>
  <footer class="entry-footer"><span title='2022-07-13 00:00:00 +0000 UTC'>July 13, 2022</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to Golang Expr不完全指南" href="https://czyt.tech/post/golang-expr-uncompleted-reference/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>Golang DSL参考
    </h2>
  </header>
  <section class="entry-content">
    <p>ANTLR 4 图书 The definitive ANTLR 4 reference (2014) 英文版下载 中文版下载 文章 使用ANTLR和Go实现DSL入门 手把手教你使用ANTLR和Go实现一门DSL语言part1 part2part3part4part5 Parsing with ANTLR 4 and Go 实例代码 bilibili gengine link go-zero link grule-rule-engine Others 图书 Writing A Compiler In Go Writing an Interpreter in Go µGo语言实现——从头开发一个迷你Go语言编译器 文章 Build your own DSL with Go &amp; HCL
How to Write Syntax Tree-Based Domain-Specific Languages in Go
Handwritten Parsers &amp; Lexers in Go
goyacc实战
TiDB SQL Parser 的实现...</p>
  </section>
  <footer class="entry-footer"><span title='2022-07-11 00:00:00 +0000 UTC'>July 11, 2022</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to Golang DSL参考" href="https://czyt.tech/post/golang-dsl-reference/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>Golang io.Pipe 使用
    </h2>
  </header>
  <section class="entry-content">
    <p>介绍 // Pipe creates a synchronous in-memory pipe. // It can be used to connect code expecting an io.Reader // with code expecting an io.Writer. // // Reads and Writes on the pipe are matched one to one // except when multiple Reads are needed to consume a single Write. // That is, each Write to the PipeWriter blocks until it has satisfied // one or more Reads from the PipeReader that fully consume // the written data....</p>
  </section>
  <footer class="entry-footer"><span title='2022-06-24 00:00:00 +0000 UTC'>June 24, 2022</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;czyt</footer>
  <a class="entry-link" aria-label="post link to Golang io.Pipe 使用" href="https://czyt.tech/post/golang-io-pipe-usage/"></a>
</article>
<footer class="page-footer">
  <nav class="pagination">
    <a class="next" href="https://czyt.tech/tags/golang/page/2/">Next Page »</a>
  </nav>
</footer>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://czyt.tech/">虫子樱桃</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
        <span id="busuanzi_container_site_pv">Total visited<span id="busuanzi_value_site_pv"></span>times</span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }
const loadScript = (url, onloadFunction) => {
    var newScript = document.createElement("script");
    newScript.onerror =  (oError) => {
      throw new URIError("The script " + oError.target.src + " didn't load correctly.");
    };
    if (onloadFunction) { newScript.onload = onloadFunction; }
    document.head.insertAdjacentElement('beforeend', newScript);
    newScript.src = url;
  }
  
if (document.querySelectorAll('.mermaid').length > 0) {
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js', () => {
        document.head.insertAdjacentHTML("beforeend", `<style>.mermaid svg { background-color: #dadcd8 !important; }</style>`);
        // default, dark, neutral, forest
        mermaid.initialize({ startOnLoad: false, securityLevel: "strict", logLevel: 1, theme: "neutral" });
        
        
        mermaid.init();
        console.log("mermaid init done");
      })
    }
    
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
